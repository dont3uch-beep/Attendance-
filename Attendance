<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pharm-D CR</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#007bff">

    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --dark: #212529; --bg: #f0f2f5; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto; 
            background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; 
        }

        /* The App Header */
        .app-card { 
            background: white; width: 100%; max-width: 450px; padding: 25px;
            border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center; border-top: 8px solid var(--primary);
        }

        .cr-badge { color: var(--primary); font-weight: bold; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
        #clock { font-size: 0.85rem; color: #666; margin: 10px 0 20px 0; font-weight: 500; }

        input { 
            width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #ddd;
            border-radius: 12px; font-size: 1.1rem; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--primary); }

        .btn { 
            width: 100%; padding: 16px; border: none; border-radius: 12px; 
            font-weight: bold; font-size: 1rem; cursor: pointer; color: white; margin-bottom: 10px;
        }
        .btn-main { background: var(--success); font-size: 1.1rem; }
        .btn-sub { background: #6c757d; }

        /* Student Table */
        .list-container { width: 100%; max-width: 450px; margin-top: 20px; }
        #searchBox { background: white; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        table { 
            width: 100%; background: white; border-radius: 15px; overflow: hidden;
            border-collapse: collapse; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        th { background: var(--dark); color: white; padding: 12px; font-size: 0.8rem; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; font-size: 0.95rem; }

        /* Footer Controls */
        .footer { 
            width: 100%; max-width: 450px; margin-top: 30px; 
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding-bottom: 40px;
        }
        .btn-footer { padding: 12px; border-radius: 10px; font-size: 0.8rem; }
        .bg-info { background: #17a2b8; grid-column: span 2; }
        .bg-save { background: #495057; }
        .bg-reset { background: var(--danger); }

        /* Modal */
        #modalOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:99; }
        #modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; width:85%; max-width:350px; padding:20px; border-radius:20px; z-index:100; }
        .history-row { display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee; }
    </style>
</head>
<body>

    <div class="app-card">
        <div class="cr-badge">CR: ZUHAIB ALI</div>
        <h1 style="margin:5px 0 0 0;">Pharm-D 2k25</h1>
        <div id="clock">Loading...</div>
        
        <input type="number" id="roll" placeholder="Enter Roll Number" pattern="\d*">
        
        <button class="btn btn-main" onclick="mark(new Date().toLocaleDateString('en-GB'))">Mark Today</button>
        <button class="btn btn-sub" onclick="markManual()">Add Previous Date</button>
    </div>

    <div class="list-container">
        <input type="text" id="searchBox" placeholder="ðŸ”Ž Search Students..." onkeyup="renderTable()">
        <table>
            <thead>
                <tr><th>Roll No</th><th>Total</th><th>History</th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="footer">
        <button class="btn btn-footer bg-info" onclick="exportData()">Download CSV Report</button>
        <button class="btn btn-footer bg-save" onclick="alert('Data Saved Locally!')">Force Save</button>
        <button class="btn btn-footer bg-reset" onclick="resetAll()">Reset All</button>
    </div>

    <div id="modalOverlay" onclick="closeModal()"></div>
    <div id="modal">
        <h3 id="mHeader" style="margin-top:0">Roll History</h3>
        <div id="mList" style="max-height: 200px; overflow-y: auto;"></div>
        <button onclick="closeModal()" style="width:100%; margin-top:15px; background:var(--dark); color:white; border:none; padding:10px; border-radius:10px;">Close</button>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('PHARM_APP_DATA')) || {};

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleString('en-GB', { weekday: 'long', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        function mark(dateStr) {
            const rollVal = document.getElementById('roll').value.trim();
            if (!rollVal) return alert("Please enter a roll number");
            
            if (!db[rollVal]) db[rollVal] = [];
            if (db[rollVal].includes(dateStr)) {
                alert("Roll " + rollVal + " already marked for " + dateStr);
            } else {
                db[rollVal].push(dateStr);
                save();
            }
            document.getElementById('roll').value = '';
        }

        function markManual() {
            const d = prompt("Enter Date (DD/MM/YYYY):", "11/02/2026");
            if (d) mark(d);
        }

        function save() {
            localStorage.setItem('PHARM_APP_DATA', JSON.stringify(db));
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const search = document.getElementById('searchBox').value;
            tbody.innerHTML = '';
            
            Object.keys(db).sort((a,b) => a-b).forEach(roll => {
                if (roll.includes(search)) {
                    tbody.innerHTML += `<tr>
                        <td><b>${roll}</b></td>
                        <td>${db[roll].length}</td>
                        <td><button onclick="showHistory('${roll}')" style="background:var(--primary); color:white; border:none; padding:5px 10px; border-radius:5px;">Edit</button></td>
                    </tr>`;
                }
            });
        }

        function showHistory(roll) {
            document.getElementById('mHeader').innerText = "Roll: " + roll;
            const list = document.getElementById('mList');
            list.innerHTML = '';
            db[roll].forEach((d, i) => {
                list.innerHTML += `<div class="history-row"><span>${d}</span> <span style="color:red" onclick="removeEntry('${roll}', ${i})">Delete</span></div>`;
            });
            document.getElementById('modal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';
        }

        function removeEntry(roll, index) {
            if (confirm("Delete this entry?")) {
                db[roll].splice(index, 1);
                save();
                showHistory(roll);
            }
        }

        function exportData() {
            const date = prompt("Enter Date for CSV:", new Date().toLocaleDateString('en-GB'));
            if (!date) return;
            let csv = "Present Students for " + date + "\nRoll Number\n";
            Object.keys(db).forEach(r => { if(db[r].includes(date)) csv += r + "\n"; });
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Attendance_${date}.csv`;
            link.click();
        }

        function resetAll() {
            if (prompt("Type 'RESET' to delete all data:") === "RESET") {
                db = {}; save();
            }
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
        }

        renderTable();
    </script>
</body>
</html>
